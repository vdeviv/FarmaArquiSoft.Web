@page
@model FarmaArquiSoft.Web.Pages.Sales.IndexModel
@{
    ViewData["Title"] = "Historial de Ventas";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-success">
        <i class="bi bi-receipt me-2"></i> Historial de Ventas
    </h2>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0 text-center">
            <thead class="table-success">
                <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Total (Bs)</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Sales.Any())
                {
                    foreach (var s in Model.Sales)
                    {
                        <tr class="@(s.Status == "CANCELLED" ? "table-secondary" : "")">
                            <td>@s.Date.ToString("dd/MM/yyyy")</td>
                            <td>@s.ClientName</td>
                            <td class="fw-bold">Bs. @s.TotalAmount.ToString("F2")</td>
                            <td>
                                <span class="badge rounded-pill
                                            @(s.Status == "ACTIVE" ? "bg-success" : "bg-danger")">
                                    @s.Status
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary rounded-pill"
                                        onclick="openDetail('@s.Id')">
                                    <i class="bi bi-eye"></i>
                                </button>

                                @if (s.Status == "ACTIVE")
                                {
                                    <button class="btn btn-sm btn-outline-danger rounded-pill"
                                            onclick="cancelSale('@s.Id')">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-muted py-4">
                            No hay ventas registradas.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<partial name="_SaleDetailModal" />

@section Scripts {
    <script>
        // ------------------------------------------------------------------
        // CONFIGURACIÓN: Backend for Frontend
        // Ahora llamamos al Handler C# de esta misma página, no al puerto 5002.
        // Esto soluciona los errores de CORS, SSL y Autenticación.
        // ------------------------------------------------------------------
        const PAGE_HANDLER_URL = "?handler=SaleDetails&id=";

        // Formateador de moneda para Bolivianos
        const formatter = new Intl.NumberFormat('es-BO', {
            style: 'currency',
            currency: 'BOB'
        });

        async function openDetail(saleId) {
            console.log("Solicitando detalles al servidor para venta:", saleId);

            // 1. Obtener referencias al DOM del modal
            const tbody = document.querySelector('#saleDetailModal tbody');
            const totalSpan = document.querySelector('#saleDetailModal #modalTotalAmount');

            // Validación de seguridad por si el modal cambió
            if(!tbody) {
                console.error("Error: No se encontró el cuerpo de la tabla en el modal.");
                return;
            }

            // 2. Mostrar estado de carga
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-primary"><div class="spinner-border spinner-border-sm me-2"></div>Cargando datos...</td></tr>';
            if(totalSpan) totalSpan.textContent = "---";

            // 3. Abrir el modal inmediatamente
            const modalElement = document.getElementById('saleDetailModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            try {
                // 4. Llamada AJAX al Handler OnGetSaleDetailsAsync de tu Index.cshtml.cs
                const response = await fetch(`${PAGE_HANDLER_URL}${saleId}`, {
                    method: 'GET'
                    // No necesitamos headers de Auth manuales, la cookie viaja sola
                });

                if (!response.ok) {
                    throw new Error(`Error del Servidor Web: ${response.status}`);
                }

                const details = await response.json();
                console.log("Datos recibidos:", details);

                // 5. Renderizar los datos
                tbody.innerHTML = ''; // Limpiar mensaje de carga
                let totalAcumulado = 0;

                if (!details || details.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No hay detalles registrados para esta venta.</td></tr>';
                } else {
                            details.forEach(d => {
            // 1. Extraer propiedades (Soporta PascalCase, camelCase y snake_case)
            const medId = d.MedicineId || d.medicineId || d.medicine_id || 'N/A';

            // 2. CORRECCIÓN: Priorizar el nombre del medicamento
            const medName = d.MedicineName || d.medicineName || `Producto ID: ${medId}`;

            const qty = d.Quantity || d.quantity || 0;
            const price = d.UnitPrice || d.unitPrice || d.unit_price || 0;
            const amount = d.TotalAmount || d.totalAmount || d.total_amount || 0;

            totalAcumulado += amount;

            // 3. Renderizar fila con el nombre visible y el ID pequeño debajo
            const row = `
                    <tr>
            <td class="text-start">
                <div class="fw-bold text-dark">${medName}</div>
            </td>
            <td class="text-center align-middle">${qty}</td>
            <td class="text-end align-middle">${formatter.format(price)}</td>
            <td class="text-end align-middle fw-bold">${formatter.format(amount)}</td>
        </tr>
            `;
            tbody.innerHTML += row;
        });
                }

                // 6. Actualizar el Total en el pie del modal
                if(totalSpan) {
                    totalSpan.textContent = formatter.format(totalAcumulado);
                }

            } catch (error) {
                console.error("Error cargando detalles:", error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger fw-bold"><i class="bi bi-exclamation-triangle"></i> Error al cargar: ${error.message}</td></tr>`;
            }
        }

        function cancelSale(id) {
            if (!confirm("¿Está seguro de que desea ANULAR esta venta? Esta acción no se puede deshacer.")) return;

            console.log("Iniciando anulación de venta:", id);
            // Aquí implementarías la llamada al handler de cancelación si lo tuvieras
            // fetch(`?handler=CancelSale&id=${id}`, { method: 'POST' })...
            alert("Funcionalidad de anulación pendiente de implementación.");
        }
    </script>
}